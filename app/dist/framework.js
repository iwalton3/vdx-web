let debugReactivityHook=null;let onBeforeEffectFlush=null;let onAfterEffectFlush=null;function registerEffectFlushHooks(before,after){onBeforeEffectFlush=before;onAfterEffectFlush=after;}let activeEffect=null;const effectStack=[];function withoutTracking(fn){const savedActiveEffect=activeEffect;const savedStack=effectStack.slice();activeEffect=null;effectStack.length=0;try{return fn();}finally{effectStack.length=0;for (const effect of savedStack){effectStack.push(effect);}activeEffect=savedActiveEffect;}}function createEffect(fn){let disposed=false;const effect=()=>{if (disposed) return;activeEffect=effect;effectStack.push(effect);try{return fn();}catch (e){console.error('[Effect Error] An error occurred in a reactive effect:',e);}finally{effectStack.pop();activeEffect=effectStack[effectStack.length-1];}};effect.deps=new Set();const dispose=()=>{if (disposed) return;disposed=true;effect.deps.forEach(dep=>{dep.delete(effect);});effect.deps.clear();const index=effectStack.indexOf(effect);if (index!==-1){effectStack.splice(index,1);}if (activeEffect===effect){activeEffect=null;}};effect();return{effect,dispose};}function track(target,key){if (activeEffect){let depsMap=targetMap.get(target);if (!depsMap){targetMap.set(target,(depsMap=new Map()));}let deps=depsMap.get(key);if (!deps){depsMap.set(key,(deps=new Set()));}deps.add(activeEffect);activeEffect.deps.add(deps);}}const runningEffects=new Set();const pendingEffects=new Set();let flushScheduled=false;let isFlushing=false;const MAX_FLUSH_ITERATIONS=100;function scheduleFlush(){if (flushScheduled||isFlushing) return;flushScheduled=true;queueMicrotask(flushEffects);}function flushEffects(){if (isFlushing) return;isFlushing=true;let iterations=0;try{do{if (onBeforeEffectFlush) onBeforeEffectFlush();while (pendingEffects.size>0){iterations++;if (iterations>MAX_FLUSH_ITERATIONS){console.error('[Reactivity] Max flush iterations exceeded - possible infinite effect loop');pendingEffects.clear();break;}const effects=[...pendingEffects];pendingEffects.clear();for (const effect of effects){if (!runningEffects.has(effect)){runningEffects.add(effect);try{effect();}finally{runningEffects.delete(effect);}}}}if (onAfterEffectFlush) onAfterEffectFlush();}while (pendingEffects.size>0&&iterations<MAX_FLUSH_ITERATIONS);}finally{isFlushing=false;flushScheduled=false;}}function trigger(target,key){const depsMap=targetMap.get(target);if (!depsMap) return;const deps=depsMap.get(key);if (deps){if (debugReactivityHook){debugReactivityHook(target,key,target[key],`trigger(${deps.size} effects)`);}for (const effect of deps){pendingEffects.add(effect);}scheduleFlush();}}const targetMap=new WeakMap();function reactive(obj){if (obj===null||typeof obj!=='object'){return obj;}if (obj.__isReactive){return obj;}if (obj instanceof Set||obj instanceof Map||obj instanceof WeakSet||obj instanceof WeakMap||obj instanceof Promise||obj instanceof Error){return obj;}if ('_compiled'in obj&&'_values'in obj){return obj;}const isDate=obj instanceof Date;const untrackedKeys=new Set();for (const key in obj){if (obj[key]!==null&&typeof obj[key]==='object'&&obj[key][UNTRACKED]){untrackedKeys.add(key);}}const proxy=new Proxy(obj,{get(target,key,receiver){if (key==='__isReactive'){return true;}track(target,key);const value=Reflect.get(target,key,receiver);if (isDate&&typeof value==='function'){return value.bind(target);}if (Array.isArray(target)&&typeof value==='function'){const arrayMethods=['push','pop','shift','unshift','splice','sort','reverse'];if (arrayMethods.includes(key)){return function(...args){const result=value.apply(target,args);trigger(target,'length');return result;};}}if (typeof value==='object'&&value!==null&&!(value instanceof Set)&&!(value instanceof Map)&&!(value instanceof WeakSet)&&!(value instanceof WeakMap)&&!(value instanceof Promise)&&!(value instanceof Error)&&!(typeof Node!=='undefined'&&value instanceof Node)&&!('_compiled'in value&&'_values'in value)){return reactive(value);}return value;},set(target,key,value,receiver){const oldValue=target[key];if (untrackedKeys.has(key)&&value!==null&&typeof value==='object'&&!value[UNTRACKED]){untracked(value);}const result=Reflect.set(target,key,value,receiver);const isObjectAssignment=value!==null&&typeof value==='object';if (oldValue!==value||isObjectAssignment){if (debugReactivityHook){debugReactivityHook(target,key,value,'set');}trigger(target,key);}return result;},deleteProperty(target,key){const result=Reflect.deleteProperty(target,key);trigger(target,key);return result;}});return proxy;}function computed(getter){let value;let dirty=true;let firstRun=true;const{dispose}=createEffect(()=>{if (firstRun){value=getter();dirty=false;firstRun=false;}else{dirty=true;}});const get=()=>{if (dirty){value=getter();dirty=false;}return value;};return{get,dispose};}function watch(fn,callback){let oldValue;const{dispose}=createEffect(()=>{const newValue=fn();if (callback&&oldValue!==undefined){callback(newValue,oldValue);}oldValue=newValue;});return dispose;}function isReactive(value){return!!(value&&value.__isReactive);}const UNTRACKED=Symbol('untracked');function untracked(obj){if (obj!==null&&typeof obj==='object'){Object.defineProperty(obj,UNTRACKED,{value:true,enumerable:false,writable:false,configurable:false});}return obj;}function isUntracked(obj){return obj!==null&&typeof obj==='object'&&obj[UNTRACKED]===true;}function memo(fn,deps){let cachedValue;let lastDeps=null;let dirty=true;return (...args)=>{if (deps){const depsChanged=!lastDeps||deps.some((dep,i)=>dep!==lastDeps[i]);if (depsChanged){dirty=true;lastDeps=[...deps];}}if (dirty){cachedValue=fn(...args);dirty=false;}return cachedValue;};}function trackAllDependencies(obj,visited){if (obj==null||typeof obj!=='object') return;if (!visited) visited=new Set();if (visited.has(obj)) return;visited.add(obj);if (obj[UNTRACKED]) return;if (Array.isArray(obj)){const len=obj.length;if (len>100){return;}for (let i=0;i<len;i++){const item=obj[i];if (item!==null&&typeof item==='object'){if (item.__isReactive){trackAllDependencies(item,visited);}}}return;}for (const key in obj){if (key==='__isReactive'||key===UNTRACKED) continue;try{const value=obj[key];if (value!==null&&typeof value==='object'&&value.__isReactive){trackAllDependencies(value,visited);}}catch (e){}}}const templateCompiler={compileTemplate:compileTemplate,clearTemplateCache:clearTemplateCache,pruneTemplateCache:pruneTemplateCache,getTemplateCacheSize:getTemplateCacheSize};const HTML_MARKER=Symbol('html');const RAW_MARKER=Symbol('raw');const CONTAIN_MARKER=Symbol('contain');let currentRenderComponent=null;function setRenderContext(component){currentRenderComponent=component;}const isHtml=(obj)=>obj&&obj[HTML_MARKER]===true;const isRaw=(obj)=>obj&&obj[RAW_MARKER]===true;const isContain=(obj)=>obj&&obj[CONTAIN_MARKER]===true;const OP={STATIC:0,SLOT:1,TEXT:2,ELEMENT:3,FRAGMENT:4,};function normalizeInput(input){if (input==null) return'';let str=String(input);str=str.replace(/\x00/g,'');str=str.replace(/^\uFEFF/,'');if (typeof str.normalize==='function'){str=str.normalize('NFC');}str=str.replace(/[\uFDD0-\uFDEF\uFFFE\uFFFF]/g,'');str=str.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F]/g,'');return str;}function sanitizeUrl(url){const normalized=normalizeInput(url);const cleaned=normalized.replace(/\s/g,'');const decoded=cleaned.replace(/&colon;/gi,':').replace(/&#58;/g,':').replace(/&#x3a;/gi,':').replace(/&sol;/gi,'/').replace(/&#47;/g,'/').replace(/&#x2f;/gi,'/');const schemeMatch=decoded.match(/^([a-zA-Z][a-zA-Z0-9+.-]*?):/);if (!schemeMatch){return normalized;}const scheme=schemeMatch[1].toLowerCase();const safeSchemes=['http','https','mailto','tel','sms','ftp','ftps'];if (!safeSchemes.includes(scheme)){console.warn('[Security] Blocked dangerous URL scheme:',url);return'';}return normalized;}function html(strings,...values){const{compileTemplate}=html._compiler;const compiled=compileTemplate(strings);return{[HTML_MARKER]:true,_compiled:compiled,_values:values,toString(){return'';}};}function raw(htmlString){return{[RAW_MARKER]:true,toString(){return htmlString;}};}const EMPTY_COMPILED={op:OP.STATIC,template:null,type:'fragment',wrapped:false,children:[]};const EMPTY_WHEN_RESULT={[HTML_MARKER]:true,_compiled:EMPTY_COMPILED,toString(){return'';}};function when(condition,thenValue,elseValue=null){const isFunctionForm=typeof thenValue==='function'||typeof elseValue==='function';if (isFunctionForm&&currentRenderComponent){if (!currentRenderComponent._whenCaches){currentRenderComponent._whenCaches=new WeakMap();}const cacheKey=typeof thenValue==='function'?thenValue:elseValue;if (cacheKey&&typeof cacheKey==='function'){let cacheData=currentRenderComponent._whenCaches.get(cacheKey);if (!cacheData){cacheData={lastCondition:undefined,lastResult:null};currentRenderComponent._whenCaches.set(cacheKey,cacheData);}const conditionTruthy=!!condition;if (cacheData.lastCondition===conditionTruthy&&cacheData.lastResult){return cacheData.lastResult;}cacheData.lastCondition=conditionTruthy;let result=condition?thenValue:elseValue;if (typeof result==='function'){result=result();}if (!result){cacheData.lastResult=EMPTY_WHEN_RESULT;return EMPTY_WHEN_RESULT;}cacheData.lastResult=result;return result;}}let result=condition?thenValue:elseValue;if (typeof result==='function'){result=result();}if (!result){return EMPTY_WHEN_RESULT;}if (isHtml(result)){return result;}if (typeof result==='function'){return when(condition,result());}return result;}function contain(renderFn){if (typeof renderFn!=='function'){console.warn('[contain] Expected a function, got:',typeof renderFn);return renderFn;}return{[CONTAIN_MARKER]:true,[HTML_MARKER]:true,_renderFn:renderFn,_compiled:{op:OP.SLOT,type:'contain',isContain:true},toString(){return'[contain]';}};}function each(array,mapFn,keyFn=null){if (!array||!Array.isArray(array)){return{[HTML_MARKER]:true,_compiled:{op:OP.STATIC,template:null,type:'fragment',wrapped:false,children:[]},toString(){return'';}};}const results=array.map((item,index)=>{const result=mapFn(item,index);if (keyFn&&result&&result._compiled){const key=keyFn(item,index);return{...result,_compiled:{...result._compiled,key:key}};}return result;});const compiledChildren=results.map((r,itemIndex)=>{if (!r||!r._compiled) return null;const child=r._compiled;const childValues=r._values;if (child.type==='text'&&child.value&&/^\s*$/.test(child.value)){return null;}if (child.type==='fragment'&&!child.wrapped&&child.children.length===1&&child.children[0].type==='element'){const element=child.children[0];const key=keyFn?keyFn(array[itemIndex],itemIndex):itemIndex;return{...element,key,_itemValues:childValues};}const key=keyFn?keyFn(array[itemIndex],itemIndex):itemIndex;return{...child,key,_itemValues:childValues};}).filter(Boolean);return{[HTML_MARKER]:true,_compiled:{op:OP.FRAGMENT,type:'fragment',wrapped:false,fromEach:true,hasExplicitKeys:!!keyFn,children:compiledChildren},toString(){return'';}};}function createMemoCache(){return new Map();}function memoEach(array,mapFn,keyFn,cache){if (!array||!Array.isArray(array)){return{[HTML_MARKER]:true,_compiled:{op:OP.STATIC,template:null,type:'fragment',wrapped:false,children:[]},toString(){return'';}};}if (!keyFn){return each(array,mapFn,null);}let effectiveCache=null;if (cache){if (cache instanceof Map){effectiveCache=cache;}else if (cache.itemCache){effectiveCache=cache.itemCache;}}else if (currentRenderComponent){const callSiteId=mapFn.toString()+'||'+keyFn.toString();if (!currentRenderComponent._memoCallSiteCaches){currentRenderComponent._memoCallSiteCaches=new Map();}if (!currentRenderComponent._memoCallSiteCaches.has(callSiteId)){currentRenderComponent._memoCallSiteCaches.set(callSiteId,new Map());}effectiveCache=currentRenderComponent._memoCallSiteCaches.get(callSiteId);}if (!effectiveCache){return each(array,mapFn,keyFn);}const results=array.map((item,index)=>{const key=keyFn(item,index);const cached=effectiveCache.get(key);if (cached&&cached.item===item){return cached.result;}const result=mapFn(item,index);if (result&&result._compiled){const keyedResult={...result,_compiled:{...result._compiled,key:key}};effectiveCache.set(key,{item,result:keyedResult});return keyedResult;}effectiveCache.set(key,{item,result});return result;});const compiledChildren=results.map((r,itemIndex)=>{if (!r||!r._compiled) return null;const child=r._compiled;const childValues=r._values;if (child.type==='text'&&child.value&&/^\s*$/.test(child.value)){return null;}if (child.type==='fragment'&&!child.wrapped&&child.children.length===1&&child.children[0].type==='element'){const element=child.children[0];const key=keyFn(array[itemIndex],itemIndex);return{...element,key,_itemValues:childValues};}const key=keyFn(array[itemIndex],itemIndex);return{...child,key,_itemValues:childValues};}).filter(Boolean);return{[HTML_MARKER]:true,_compiled:{op:OP.FRAGMENT,type:'fragment',wrapped:false,fromEach:true,hasExplicitKeys:true,children:compiledChildren},toString(){return'';}};}function awaitThen(promiseOrValue,thenFn,pendingContent,catchFn=null){return html`
        <x-await-then
            promise="${promiseOrValue}"
            then="${thenFn}"
            pending="${pendingContent}"
            catch="${catchFn}">
        </x-await-then>
    `;}html._compiler=templateCompiler;const State={TEXT:0,TAG_OPEN:1,TAG_NAME:2,TAG_SPACE:3,ATTR_NAME:4,ATTR_EQ:5,ATTR_VALUE_START:6,ATTR_VALUE:7,END_TAG:8,COMMENT:9,TAG_SELF_CLOSE:10};const VOID_ELEMENTS=new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);const KNOWN_MODIFIERS=new Set(['prevent','stop']);const HTML_ENTITIES=new Map([['lt','<'],['gt','>'],['amp','&'],['quot','"'],['apos',"'"],['nbsp','\u00A0'],['copy','\u00A9'],['reg','\u00AE'],['trade','\u2122'],['mdash','\u2014'],['ndash','\u2013'],['lsquo','\u2018'],['rsquo','\u2019'],['ldquo','\u201C'],['rdquo','\u201D'],['bull','\u2022'],['hellip','\u2026'],['euro','\u20AC'],['pound','\u00A3'],['yen','\u00A5'],['cent','\u00A2'],['deg','\u00B0'],['plusmn','\u00B1'],['times','\u00D7'],['divide','\u00F7'],['frac12','\u00BD'],['frac14','\u00BC'],['frac34','\u00BE'],['para','\u00B6'],['sect','\u00A7'],['dagger','\u2020'],['Dagger','\u2021'],['laquo','\u00AB'],['raquo','\u00BB'],['iexcl','\u00A1'],['iquest','\u00BF'],['acute','\u00B4'],['cedil','\u00B8'],['macr','\u00AF'],['micro','\u00B5'],['middot','\u00B7'],['ordf','\u00AA'],['ordm','\u00BA'],['sup1','\u00B9'],['sup2','\u00B2'],['sup3','\u00B3'],['not','\u00AC'],['shy','\u00AD'],['brvbar','\u00A6'],['curren','\u00A4'],['Alpha','\u0391'],['Beta','\u0392'],['Gamma','\u0393'],['Delta','\u0394'],['Epsilon','\u0395'],['Zeta','\u0396'],['Eta','\u0397'],['Theta','\u0398'],['Iota','\u0399'],['Kappa','\u039A'],['Lambda','\u039B'],['Mu','\u039C'],['Nu','\u039D'],['Xi','\u039E'],['Omicron','\u039F'],['Pi','\u03A0'],['Rho','\u03A1'],['Sigma','\u03A3'],['Tau','\u03A4'],['Upsilon','\u03A5'],['Phi','\u03A6'],['Chi','\u03A7'],['Psi','\u03A8'],['Omega','\u03A9'],['alpha','\u03B1'],['beta','\u03B2'],['gamma','\u03B3'],['delta','\u03B4'],['epsilon','\u03B5'],['zeta','\u03B6'],['eta','\u03B7'],['theta','\u03B8'],['iota','\u03B9'],['kappa','\u03BA'],['lambda','\u03BB'],['mu','\u03BC'],['nu','\u03BD'],['xi','\u03BE'],['omicron','\u03BF'],['pi','\u03C0'],['rho','\u03C1'],['sigmaf','\u03C2'],['sigma','\u03C3'],['tau','\u03C4'],['upsilon','\u03C5'],['phi','\u03C6'],['chi','\u03C7'],['psi','\u03C8'],['omega','\u03C9'],['larr','\u2190'],['uarr','\u2191'],['rarr','\u2192'],['darr','\u2193'],['harr','\u2194'],['crarr','\u21B5'],['lArr','\u21D0'],['uArr','\u21D1'],['rArr','\u21D2'],['dArr','\u21D3'],['hArr','\u21D4'],['forall','\u2200'],['part','\u2202'],['exist','\u2203'],['empty','\u2205'],['nabla','\u2207'],['isin','\u2208'],['notin','\u2209'],['ni','\u220B'],['prod','\u220F'],['sum','\u2211'],['minus','\u2212'],['lowast','\u2217'],['radic','\u221A'],['prop','\u221D'],['infin','\u221E'],['ang','\u2220'],['and','\u2227'],['or','\u2228'],['cap','\u2229'],['cup','\u222A'],['int','\u222B'],['there4','\u2234'],['sim','\u223C'],['cong','\u2245'],['asymp','\u2248'],['ne','\u2260'],['equiv','\u2261'],['le','\u2264'],['ge','\u2265'],['sub','\u2282'],['sup','\u2283'],['nsub','\u2284'],['sube','\u2286'],['supe','\u2287'],['oplus','\u2295'],['otimes','\u2297'],['perp','\u22A5'],['sdot','\u22C5'],['spades','\u2660'],['clubs','\u2663'],['hearts','\u2665'],['diams','\u2666'],['loz','\u25CA'],['lceil','\u2308'],['rceil','\u2309'],['lfloor','\u230A'],['rfloor','\u230B'],['lang','\u2329'],['rang','\u232A'],['ensp','\u2002'],['emsp','\u2003'],['thinsp','\u2009'],['zwnj','\u200C'],['zwj','\u200D'],['lrm','\u200E'],['rlm','\u200F']]);function decodeEntity(entity){if (entity.startsWith('#')&&!entity.startsWith('#x')&&!entity.startsWith('#X')){const code=parseInt(entity.slice(1),10);if (!isNaN(code)&&code>=0&&code<=0x10FFFF){return String.fromCodePoint(code);}return null;}if (entity.startsWith('#x')||entity.startsWith('#X')){const code=parseInt(entity.slice(2),16);if (!isNaN(code)&&code>=0&&code<=0x10FFFF){return String.fromCodePoint(code);}return null;}return HTML_ENTITIES.get(entity)||null;}function decodeEntities(str){if (!str.includes('&')) return str;return str.replace(/&([a-zA-Z][a-zA-Z0-9]*|#[0-9]+|#[xX][0-9a-fA-F]+);?/g,(match,entity)=>{if (match.endsWith(';')){const decoded=decodeEntity(entity);return decoded!==null?decoded:match;}return match;});}function htmlParse(strings){const parser=new Parser(strings);return parser.parse();}class Parser{constructor(strings){this.strings=strings;this.stringIndex=0;this.pos=0;this.state=State.TEXT;this.textBuffer='';this.tagName='';this.attrName='';this.attrValue='';this.attrQuote='';this.stack=[];this.root={type:'fragment',wrapped:false,children:[]};this.current=this.root;this.currentElement=null;this.attrHasSlot=false;this.attrSlots=[];this.attrTemplate='';}peek(){if (this.stringIndex>=this.strings.length) return null;const str=this.strings[this.stringIndex];if (this.pos>=str.length) return null;return str[this.pos];}consume(){const ch=this.peek();if (ch!==null){this.pos++;}return ch;}atStringEnd(){return this.pos>=this.strings[this.stringIndex].length;}hasSlotAfter(){return this.stringIndex<this.strings.length-1;}nextString(){this.stringIndex++;this.pos=0;}lookAhead(seq){const str=this.strings[this.stringIndex];return str.slice(this.pos,this.pos+seq.length)===seq;}skip(n){this.pos+=n;}parse(){while (this.stringIndex<this.strings.length){while (!this.atStringEnd()){this.processChar();}if (this.hasSlotAfter()){this.handleSlot(this.stringIndex);this.nextString();}else{break;}}this.flushText();while (this.stack.length>0){this.closeElement();}return this.root;}processChar(){const ch=this.peek();switch (this.state){case State.TEXT:this.parseText();break;case State.TAG_OPEN:this.parseTagOpen();break;case State.TAG_NAME:this.parseTagName();break;case State.TAG_SPACE:this.parseTagSpace();break;case State.ATTR_NAME:this.parseAttrName();break;case State.ATTR_EQ:this.parseAttrEq();break;case State.ATTR_VALUE_START:this.parseAttrValueStart();break;case State.ATTR_VALUE:this.parseAttrValue();break;case State.END_TAG:this.parseEndTag();break;case State.COMMENT:this.parseComment();break;case State.TAG_SELF_CLOSE:this.parseTagSelfClose();break;}}parseText(){const ch=this.peek();if (ch==='<'){this.flushText();this.consume();this.state=State.TAG_OPEN;}else{this.textBuffer+=this.consume();}}parseTagOpen(){const ch=this.peek();if (ch==='/'){this.consume();this.tagName='';this.state=State.END_TAG;}else if (ch==='!'){if (this.lookAhead('!--')){this.skip(3);this.state=State.COMMENT;}else{while (!this.atStringEnd()&&this.peek()!=='>'){this.consume();}if (this.peek()==='>') this.consume();this.state=State.TEXT;}}else if (ch==='?'||ch===null){this.textBuffer+='<';this.state=State.TEXT;}else{this.tagName='';this.state=State.TAG_NAME;}}parseTagName(){const ch=this.peek();if (ch===null||ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.finishTagName();this.state=State.TAG_SPACE;if (ch!==null) this.consume();}else if (ch==='>'){this.finishTagName();this.consume();this.openElement();this.state=State.TEXT;}else if (ch==='/'){this.finishTagName();this.consume();this.state=State.TAG_SELF_CLOSE;}else{this.tagName+=this.consume();}}finishTagName(){this.tagName=this.tagName.toLowerCase();this.currentElement={type:'element',tag:this.tagName,attrs:{},events:{},children:[]};}parseTagSpace(){const ch=this.peek();if (ch===null){return;}else if (ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.consume();}else if (ch==='>'){this.consume();this.openElement();this.state=State.TEXT;}else if (ch==='/'){this.consume();this.state=State.TAG_SELF_CLOSE;}else{this.attrName='';this.attrValue='';this.attrQuote='';this.attrHasSlot=false;this.attrSlots=[];this.attrTemplate='';this.state=State.ATTR_NAME;}}parseAttrName(){const ch=this.peek();if (ch===null){return;}else if (ch==='='){this.consume();this.state=State.ATTR_VALUE_START;}else if (ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.consume();this.state=State.ATTR_EQ;}else if (ch==='>'){this.finishAttr(true);this.consume();this.openElement();this.state=State.TEXT;}else if (ch==='/'){this.finishAttr(true);this.consume();this.state=State.TAG_SELF_CLOSE;}else{this.attrName+=this.consume();}}parseAttrEq(){const ch=this.peek();if (ch===null){return;}else if (ch==='='){this.consume();this.state=State.ATTR_VALUE_START;}else if (ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.consume();}else if (ch==='>'){this.finishAttr(true);this.consume();this.openElement();this.state=State.TEXT;}else if (ch==='/'){this.finishAttr(true);this.consume();this.state=State.TAG_SELF_CLOSE;}else{this.finishAttr(true);this.attrName='';this.attrValue='';this.attrHasSlot=false;this.attrSlots=[];this.attrTemplate='';this.state=State.ATTR_NAME;}}parseAttrValueStart(){const ch=this.peek();if (ch===null){return;}else if (ch==='"'||ch==="'"){this.attrQuote=ch;this.consume();this.state=State.ATTR_VALUE;}else if (ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.consume();}else if (ch==='>'){this.finishAttr(false);this.consume();this.openElement();this.state=State.TEXT;}else{this.attrQuote='';this.state=State.ATTR_VALUE;}}parseAttrValue(){const ch=this.peek();if (ch===null){return;}if (this.attrQuote){if (ch===this.attrQuote){this.consume();this.finishAttr(false);this.state=State.TAG_SPACE;}else{this.attrValue+=this.consume();}}else{if (ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.finishAttr(false);this.consume();this.state=State.TAG_SPACE;}else if (ch==='>'){this.finishAttr(false);this.consume();this.openElement();this.state=State.TEXT;}else if (ch==='/'){this.finishAttr(false);this.consume();this.state=State.TAG_SELF_CLOSE;}else{this.attrValue+=this.consume();}}}parseTagSelfClose(){const ch=this.peek();if (ch==='>'){this.consume();this.openElement(true);this.state=State.TEXT;}else if (ch===null){return;}else{this.state=State.TAG_SPACE;}}parseEndTag(){const ch=this.peek();if (ch==='>'){this.consume();this.closeElementByName(this.tagName.toLowerCase());this.tagName='';this.state=State.TEXT;}else if (ch===null){return;}else if (ch===' '||ch==='\t'||ch==='\n'||ch==='\r'){this.consume();}else{this.tagName+=this.consume();}}parseComment(){if (this.lookAhead('-->')){this.skip(3);this.state=State.TEXT;}else{this.consume();}}handleSlot(slotIndex){switch (this.state){case State.TEXT:this.flushText();this.current.children.push({type:'text',slot:slotIndex,context:'content'});break;case State.ATTR_VALUE:case State.ATTR_VALUE_START:this.attrHasSlot=true;this.attrSlots.push(slotIndex);this.attrTemplate+=this.attrValue+`\x00${slotIndex}\x00`;this.attrValue='';break;case State.TAG_SPACE:case State.ATTR_EQ:if (this.attrName){this.attrHasSlot=true;this.attrSlots.push(slotIndex);this.attrTemplate=`\x00${slotIndex}\x00`;this.finishAttr(false);this.state=State.TAG_SPACE;}break;case State.TAG_NAME:break;case State.ATTR_NAME:break;default:break;}}finishAttr(isBoolean){if (!this.attrName||!this.currentElement) return;const name=this.attrName;const nameLower=name.toLowerCase();let value=decodeEntities(this.attrValue);if (nameLower==='x-model'){this.handleXModel(value);}else if (nameLower==='ref'){this.currentElement.attrs['__ref__']={refName:value};}else if (nameLower.startsWith('on-')){this.handleEvent(name,value);}else{this.handleRegularAttr(name,value,isBoolean);}this.attrName='';this.attrValue='';this.attrQuote='';this.attrHasSlot=false;this.attrSlots=[];this.attrTemplate='';}handleXModel(value){const tag=this.currentElement.tag;const isCustomElement=tag.includes('-');const typeAttr=this.currentElement.attrs['type'];const inputType=typeAttr?typeAttr.value:null;if (isCustomElement){this.currentElement.attrs['value']={xModel:value,context:'x-model-value'};this.currentElement.events['change']={xModel:value,modifier:null,customElement:true};}else if (inputType==='checkbox'){this.currentElement.attrs['checked']={xModel:value,context:'x-model-checked'};this.currentElement.events['change']={xModel:value,modifier:null};}else if (inputType==='radio'){const radioValue=this.currentElement.attrs['value']?.value;this.currentElement.attrs['checked']={xModel:value,radioValue,context:'x-model-radio'};this.currentElement.events['change']={xModel:value,modifier:null};}else if (inputType==='file'){this.currentElement.events['change']={xModel:value,modifier:null};}else{this.currentElement.attrs['value']={xModel:value,context:'x-model-value'};this.currentElement.events['input']={xModel:value,modifier:null};}}handleEvent(name,value){const fullEventName=name.substring(3);let eventName,modifier;if (fullEventName==='click-outside'){eventName='clickoutside';modifier=null;}else{const parts=fullEventName.split('-');const lastPart=parts[parts.length-1];if (parts.length>1&&KNOWN_MODIFIERS.has(lastPart)){eventName=parts.slice(0,-1).join('-');modifier=lastPart;}else{eventName=fullEventName;modifier=null;}}let eventDef;if (this.attrHasSlot&&this.attrSlots.length===1&&!value){eventDef={slot:this.attrSlots[0],modifier};}else{eventDef={method:value,modifier};}if (this.currentElement.events[eventName]){eventDef._chainWith=this.currentElement.events[eventName];}this.currentElement.events[eventName]=eventDef;}handleRegularAttr(name,value,isBoolean){const tag=this.currentElement.tag;const isCustomElement=tag.includes('-');let context='attribute';if (name==='href'||name==='src'||name==='action'){context='url';}else if (name==='style'||name==='srcdoc'){context='dangerous';}else if (isCustomElement){context='custom-element-attr';}if (this.attrHasSlot){if (this.attrSlots.length===1&&(this.attrTemplate===`\x00${this.attrSlots[0]}\x00`||!this.attrTemplate)){this.currentElement.attrs[name]={slot:this.attrSlots[0],context,attrName:name};}else{let template=this.attrTemplate+value;this.currentElement.attrs[name]={slots:this.attrSlots,context,attrName:name,template};}}else if (isBoolean){this.currentElement.attrs[name]={value:name};}else{this.currentElement.attrs[name]={value};}}openElement(selfClosing=false){if (!this.currentElement) return;const el=this.currentElement;const isVoid=VOID_ELEMENTS.has(el.tag)||selfClosing;this.current.children.push(el);if (!isVoid){this.stack.push(this.current);this.current=el;}this.currentElement=null;}closeElement(){if (this.stack.length>0){this.current=this.stack.pop();}}closeElementByName(tagName){let found=-1;if (this.current.type==='element'&&this.current.tag===tagName){this.closeElement();return;}for (let i=this.stack.length-1;i>=0;i--){const el=this.stack[i];if (el.type==='element'&&el.tag===tagName){found=i;break;}}if (found>=0){while (this.stack.length>found){this.closeElement();}}}flushText(){if (this.textBuffer){let text=decodeEntities(this.textBuffer);if (/^\s+$/.test(text)){if (this.current.children.length>0||text.includes('\n')){text=' ';}else{text='';}}if (text){this.current.children.push({type:'text',value:text});}this.textBuffer='';}}}const BOOLEAN_ATTRS=new Set(['disabled','checked','selected','readonly','required','multiple','autofocus','autoplay','controls','loop','muted','open','reversed','hidden','async','defer','ismap','declare','noresize','nowrap','noshade','compact','default','scoped','seamless','sortable','novalidate','formnovalidate','itemscope']);const templateCache=new Map();const MAX_CACHE_SIZE=500;const cacheAccessTimes=new Map();function compileTemplate(strings){if (templateCache.has(strings)){cacheAccessTimes.set(strings,Date.now());return templateCache.get(strings);}const parsed=htmlParse(strings);const compiled=buildOpTree(parsed);templateCache.set(strings,compiled);cacheAccessTimes.set(strings,Date.now());if (templateCache.size>MAX_CACHE_SIZE){cleanupTemplateCache();}return compiled;}function cleanupTemplateCache(){const entries=Array.from(cacheAccessTimes.entries()).sort((a,b)=>a[1]-b[1]);const toRemove=Math.floor(entries.length*0.25);for (let i=0;i<toRemove;i++){const[staticsArray]=entries[i];templateCache.delete(staticsArray);cacheAccessTimes.delete(staticsArray);}}function buildOpTree(node){if (!node) return null;if (isFullyStatic(node)){const staticDOM=buildStaticDOM(node);return{op:OP.STATIC,template:staticDOM,type:'fragment',children:[],isStatic:true};}if (node.type==='text'){if (node.slot!==undefined){return{op:OP.SLOT,index:node.slot,context:node.context||'content',type:'text'};}return{op:OP.TEXT,value:node.value,type:'text',isStatic:true};}if (node.type==='fragment'){const children=(node.children||[]).map(child=>buildOpTree(child)).filter(Boolean);return{op:OP.FRAGMENT,children,wrapped:node.wrapped,fromEach:node.fromEach,key:node.key,type:'fragment',isStatic:children.every(c=>c.isStatic)};}if (node.type==='element'){const isCustomElement=componentDefinitions.has(node.tag);const staticProps={};const dynamicProps=[];for (const[name,attrDef]of Object.entries(node.attrs||{})){if (attrDef.value!==undefined&&attrDef.slot===undefined&&attrDef.slots===undefined&&attrDef.xModel===undefined&&attrDef.refName===undefined){staticProps[name]=attrDef.value;}else{dynamicProps.push({name,def:attrDef});}}const events=[];for (const[eventName,eventDef]of Object.entries(node.events||{})){events.push({name:eventName,def:eventDef});}const children=(node.children||[]).map(child=>buildOpTree(child)).filter(Boolean);return{op:OP.ELEMENT,tag:node.tag,staticProps,dynamicProps,events,children,isCustomElement,key:node.key,type:'element',isStatic:dynamicProps.length===0&&events.length===0&&children.every(c=>c.isStatic)};}return null;}function isFullyStatic(node){if (!node) return true;if (node.type==='text'){return node.slot===undefined;}if (node.type==='fragment'){return (node.children||[]).every(isFullyStatic);}if (node.type==='element'){if (componentDefinitions.has(node.tag)){return false;}if (node.attrs&&node.attrs.slot){return false;}for (const attrDef of Object.values(node.attrs||{})){if (attrDef.slot!==undefined||attrDef.slots!==undefined||attrDef.xModel!==undefined||attrDef.refName!==undefined){return false;}}if (Object.keys(node.events||{}).length>0){return false;}return (node.children||[]).every(isFullyStatic);}return true;}const SVG_NS='http://www.w3.org/2000/svg';function buildStaticDOM(node){if (!node) return null;return buildDOMNode(node,false);}function buildDOMNode(node,inSvg=false){if (!node) return null;if (node.type==='text'){const text=node.value||'';if (!text) return null;return document.createTextNode(text);}if (node.type==='fragment'){const children=(node.children||[]).map(child=>buildDOMNode(child,inSvg)).filter(child=>child!=null);if (children.length===0) return null;if (children.length===1) return children[0];const frag=document.createDocumentFragment();for (const child of children){frag.appendChild(child);}return frag;}if (node.type==='element'){const tag=node.tag;const isSvgElement=tag==='svg'||inSvg;const el=isSvgElement?document.createElementNS(SVG_NS,tag):document.createElement(tag);for (const[name,attrDef]of Object.entries(node.attrs||{})){if (attrDef.value!==undefined){const value=attrDef.value;if (name==='class'){el.setAttribute('class',value);}else if (name==='for'&&!isSvgElement){el.htmlFor=value;}else if (BOOLEAN_ATTRS.has(name)&&!isSvgElement){const boolVal=value===name||value==='true'||value===true;if (boolVal){el[name]=true;el.setAttribute(name,'');}}else if (value!=null&&value!==false){el.setAttribute(name,value===true?'':String(value));}}}for (const child of node.children||[]){const childDOM=buildDOMNode(child,isSvgElement);if (childDOM) el.appendChild(childDOM);}return el;}return null;}function clearTemplateCache(){templateCache.clear();cacheAccessTimes.clear();}function pruneTemplateCache(){if (templateCache.size>MAX_CACHE_SIZE*0.5){cleanupTemplateCache();}}function getTemplateCacheSize(){return templateCache.size;}const pendingAttrUpdates=new Map();const pendingTextUpdates=new Map();let isDeferringUpdates=false;let domCommitScheduled=false;function applyPendingDOMUpdates(){domCommitScheduled=false;for (const[el,attrs]of pendingAttrUpdates){for (const[name,{value,isCustomElement}]of attrs){applyAttributeDirect(el,name,value,isCustomElement);}}pendingAttrUpdates.clear();for (const[textNode,value]of pendingTextUpdates){textNode.textContent=value??'';}pendingTextUpdates.clear();}function beginDeferredUpdates(){isDeferringUpdates=true;}function commitDeferredUpdates(){isDeferringUpdates=false;if (!domCommitScheduled&&(pendingAttrUpdates.size>0||pendingTextUpdates.size>0)){domCommitScheduled=true;requestAnimationFrame(applyPendingDOMUpdates);}}function flushDOMUpdates(){if (pendingAttrUpdates.size>0||pendingTextUpdates.size>0){applyPendingDOMUpdates();}}function applyAttribute(el,name,value,isCustomElement){if (isDeferringUpdates){if (!pendingAttrUpdates.has(el)){pendingAttrUpdates.set(el,new Map());}pendingAttrUpdates.get(el).set(name,{value,isCustomElement});}else{applyAttributeDirect(el,name,value,isCustomElement);}}function applyTextContent(textNode,value){if (isDeferringUpdates){pendingTextUpdates.set(textNode,value);}else{textNode.textContent=value??'';}}const DEFERRED_CHILDREN=Symbol('vdx:deferred-children');const VALUE_GETTER=Symbol('vdx:value-getter');const DANGEROUS_KEYS=new Set(['__proto__','prototype','constructor','__defineGetter__','__defineSetter__','__lookupGetter__','__lookupSetter__']);function insertWithoutParentTracking(referenceNode,content){withoutTracking(()=>{referenceNode.after(content);});}function createDeferredChild(compiled,values,parentComponent){return{[DEFERRED_CHILDREN]:true,compiled,values,parentComponent,slotName:null};}function isDeferredChild(value){return value&&typeof value==='object'&&value[DEFERRED_CHILDREN]===true;}function instantiateTemplate(compiled,values,component,inSvg=false){const effects=[];const fragment=document.createDocumentFragment();instantiateNode(compiled,values,component,fragment,effects,inSvg);return{fragment,effects,cleanup(){for (const effect of effects){if (effect.dispose) effect.dispose();}effects.length=0;}};}function updateTemplateValues(compiled,newValues,oldValues,domNodes,effects,component){const slotMap=new Map();collectSlotNodes(domNodes,slotMap);let needsReinstantiation=false;for (const[slotIndex,info]of slotMap){if (slotIndex>=newValues.length) continue;let newValue=newValues[slotIndex];let oldValue=oldValues[slotIndex];if (typeof newValue==='function'&&newValue[VALUE_GETTER]){newValue=newValue();}if (typeof oldValue==='function'&&oldValue[VALUE_GETTER]){oldValue=oldValue();}if (newValue===oldValue) continue;if (isHtml(newValue)&&isHtml(oldValue)&&newValue._compiled===oldValue._compiled){continue;}if (info.nodes.length===1&&info.nodes[0].nodeType===Node.TEXT_NODE){if (newValue==null||newValue===false){applyTextContent(info.nodes[0],'');}else if (typeof newValue!=='object'){applyTextContent(info.nodes[0],String(newValue));}else{needsReinstantiation=true;}}else if (isHtml(newValue)||isRaw(newValue)||Array.isArray(newValue)){needsReinstantiation=true;}}updateCustomElementProps(compiled,newValues,oldValues,domNodes,component);return!needsReinstantiation;}function updateKeyedList(newChildren,oldChildren,oldItemMap,placeholder,component,slotInSvg=false,hasExplicitKeys=false){const newItemMap=new Map();const allNodes=[];const allEffects=[];const newKeys=newChildren.map(c=>c?.key);const oldKeys=oldChildren.map(c=>c?.key);const uniqueNewKeys=new Set(newKeys);const uniqueOldKeys=new Set(oldKeys);if (uniqueNewKeys.size!==newKeys.length){console.warn('[Fine-grained] DUPLICATE KEYS in newChildren!',newKeys.length,'items but only',uniqueNewKeys.size,'unique keys. First few keys:',newKeys.slice(0,5));}if (uniqueOldKeys.size!==oldKeys.length){console.warn('[Fine-grained] DUPLICATE KEYS in oldChildren!',oldKeys.length,'items but only',uniqueOldKeys.size,'unique keys. First few keys:',oldKeys.slice(0,5));}let keysIdentical=newKeys.length===oldKeys.length;if (keysIdentical){for (let i=0;i<newKeys.length;i++){if (newKeys[i]!==oldKeys[i]){keysIdentical=false;break;}}}if (keysIdentical){let insertPoint=placeholder;for (let i=0;i<newChildren.length;i++){const newChild=newChildren[i];const oldChild=oldChildren[i];const key=newChild?.key;const oldItem=oldItemMap.get(key);if (!oldItem){return null;}const sameStructure=isSameStructure(newChild,oldChild);if (sameStructure&&oldItem.valuesRef){const newValues=newChild._itemValues||[];oldItem.valuesRef.current=newValues;newItemMap.set(key,{nodes:oldItem.nodes,effects:oldItem.effects,compiled:newChild,valuesRef:oldItem.valuesRef});allNodes.push(...oldItem.nodes);allEffects.push(...oldItem.effects);if (oldItem.nodes.length>0) insertPoint=oldItem.nodes[oldItem.nodes.length-1];}else if (sameStructure){const newValues=newChild._itemValues||[];const oldValues=oldChild._itemValues||[];const success=updateTemplateValues(newChild,newValues,oldValues,oldItem.nodes,oldItem.effects,component);if (!success){for (const node of oldItem.nodes) node.remove();for (const eff of oldItem.effects) if (eff.dispose) eff.dispose();const valuesRef=reactive({current:newValues});const wrappedValues=newValues.map((_,index)=>{const getter=()=>valuesRef.current[index];getter[VALUE_GETTER]=true;return getter;});const{fragment,effects:childEffects}=instantiateTemplate(newChild,wrappedValues,component,slotInSvg);const nodes=[...fragment.childNodes];insertPoint.after(fragment);if (nodes.length>0) insertPoint=nodes[nodes.length-1];newItemMap.set(key,{nodes,effects:childEffects,compiled:newChild,valuesRef,slotInSvg});allNodes.push(...nodes);allEffects.push(...childEffects);}else{newItemMap.set(key,{nodes:oldItem.nodes,effects:oldItem.effects,compiled:newChild,slotInSvg:oldItem.slotInSvg});allNodes.push(...oldItem.nodes);allEffects.push(...oldItem.effects);if (oldItem.nodes.length>0) insertPoint=oldItem.nodes[oldItem.nodes.length-1];}}else{for (const node of oldItem.nodes) node.remove();for (const eff of oldItem.effects) if (eff.dispose) eff.dispose();const newValues=newChild._itemValues||[];const valuesRef=reactive({current:newValues});const wrappedValues=newValues.map((_,index)=>{const getter=()=>valuesRef.current[index];getter[VALUE_GETTER]=true;return getter;});const{fragment,effects:childEffects}=instantiateTemplate(newChild,wrappedValues,component,slotInSvg);const nodes=[...fragment.childNodes];insertPoint.after(fragment);if (nodes.length>0) insertPoint=nodes[nodes.length-1];newItemMap.set(key,{nodes,effects:childEffects,compiled:newChild,valuesRef});allNodes.push(...nodes);allEffects.push(...childEffects);}}return{nodes:allNodes,effects:allEffects,itemMap:newItemMap};}if (!hasExplicitKeys){return null;}const newKeySet=new Set(newKeys);for (const[oldKey,oldItem]of oldItemMap){if (!newKeySet.has(oldKey)){for (const eff of oldItem.effects){if (eff.dispose) eff.dispose();}for (const node of oldItem.nodes){if (node.parentNode) node.remove();}}}let insertPoint=placeholder;for (let i=0;i<newChildren.length;i++){const newChild=newChildren[i];const key=newChild?.key;const existingItem=oldItemMap.get(key);if (existingItem){if (existingItem.valuesRef){const newValues=newChild._itemValues||[];existingItem.valuesRef.current=newValues;}const firstNode=existingItem.nodes[0];if (firstNode&&firstNode.previousSibling!==insertPoint){for (const node of existingItem.nodes){insertPoint.after(node);insertPoint=node;}}else{if (existingItem.nodes.length>0){insertPoint=existingItem.nodes[existingItem.nodes.length-1];}}newItemMap.set(key,{nodes:existingItem.nodes,effects:existingItem.effects,compiled:newChild,valuesRef:existingItem.valuesRef,slotInSvg:existingItem.slotInSvg});allNodes.push(...existingItem.nodes);allEffects.push(...existingItem.effects);}else{const newValues=newChild._itemValues||[];const valuesRef=reactive({current:newValues});const wrappedValues=newValues.map((_,index)=>{const getter=()=>valuesRef.current[index];getter[VALUE_GETTER]=true;return getter;});const{fragment,effects:childEffects}=instantiateTemplate(newChild,wrappedValues,component,slotInSvg);const nodes=[...fragment.childNodes];insertPoint.after(fragment);if (nodes.length>0){insertPoint=nodes[nodes.length-1];}newItemMap.set(key,{nodes,effects:childEffects,compiled:newChild,valuesRef,slotInSvg});allNodes.push(...nodes);allEffects.push(...childEffects);}}if (newChildren.length>0&&allNodes.length===0){console.warn('[Fine-grained] updateKeyedList: Expected',newChildren.length,'items but created 0 nodes');return null;}return{nodes:allNodes,effects:allEffects,itemMap:newItemMap};}function isSameStructure(a,b){if (!a||!b) return a===b;if (a.op!==b.op) return false;if (a.tag!==b.tag) return false;if (a.children?.length!==b.children?.length) return false;return true;}function collectSlotNodes(domNodes,slotMap){for (const node of domNodes){collectSlotNodesRecursive(node,slotMap);}}function collectSlotNodesRecursive(node,slotMap){if (!node) return;if (node.nodeType===Node.ELEMENT_NODE&&node.tagName&&node.tagName.includes('-')){return;}if (node.childNodes&&node.childNodes.length>0){const children=Array.from(node.childNodes);let i=0;while (i<children.length){const child=children[i];if (child.nodeType===Node.COMMENT_NODE&&child.textContent&&child.textContent.startsWith('slot:')){const slotIndex=parseInt(child.textContent.slice(5),10);const contentNodes=[];let j=i+1;while (j<children.length){const sibling=children[j];if (sibling.nodeType===Node.COMMENT_NODE&&sibling.textContent&&sibling.textContent.startsWith('slot:')){break;}contentNodes.push(sibling);j++;}slotMap.set(slotIndex,{placeholder:child,nodes:contentNodes});i=j;continue;}collectSlotNodesRecursive(child,slotMap);i++;}}}function updateCustomElementProps(compiled,newValues,oldValues,domNodes,component){updatePropsInNode(compiled,newValues,oldValues,domNodes,0,component);}function updatePropsInNode(node,newValues,oldValues,domNodes,nodeIndex,component){if (!node) return nodeIndex;switch (node.op){case OP.STATIC:return nodeIndex+1;case OP.TEXT:return nodeIndex+1;case OP.SLOT:return nodeIndex+1;case OP.ELEMENT:if (node.isCustomElement){const el=domNodes[nodeIndex];if (el&&el.nodeType===Node.ELEMENT_NODE){for (const{name,def}of node.dynamicProps||[]){if (def.slot!==undefined){const newValue=newValues[def.slot];const oldValue=oldValues[def.slot];if (newValue!==oldValue){let value=newValue;if (typeof value==='function'&&value[VALUE_GETTER]){value=value();}applyAttribute(el,name,value,true);}}}}}return nodeIndex+1;case OP.FRAGMENT:for (const child of node.children||[]){nodeIndex=updatePropsInNode(child,newValues,oldValues,domNodes,nodeIndex,component);}return nodeIndex;default:return nodeIndex;}}function instantiateNode(node,values,component,parent,effects,inSvg=false){if (!node) return;switch (node.op){case OP.STATIC:instantiateStatic(node,parent,inSvg);break;case OP.SLOT:instantiateSlot(node,values,component,parent,effects,inSvg);break;case OP.TEXT:instantiateText(node,parent);break;case OP.ELEMENT:instantiateElement(node,values,component,parent,effects,inSvg);break;case OP.FRAGMENT:instantiateFragment(node,values,component,parent,effects,inSvg);break;}}function instantiateStatic(node,parent,inSvg=false){if (node.template){const clone=document.importNode(node.template,true);if (inSvg&&clone.nodeType===Node.ELEMENT_NODE){const fixed=fixSvgNamespace(clone);parent.appendChild(fixed);}else{parent.appendChild(clone);}}}function fixSvgNamespace(element){if (element.namespaceURI===RENDERER_SVG_NS){return element;}const fixed=document.createElementNS(RENDERER_SVG_NS,element.tagName.toLowerCase());for (const attr of element.attributes){fixed.setAttribute(attr.name,attr.value);}while (element.firstChild){const child=element.firstChild;if (child.nodeType===Node.ELEMENT_NODE){fixed.appendChild(fixSvgNamespace(child));}else{fixed.appendChild(child);}}return fixed;}function instantiateText(node,parent){if (node.value!=null){parent.appendChild(document.createTextNode(node.value));}}function instantiateSlot(node,values,component,parent,effects,inSvg=false){const placeholder=document.createComment('');parent.appendChild(placeholder);const slotInSvg=inSvg||(parent.namespaceURI===RENDERER_SVG_NS);let currentNodes=[];let currentEffects=[];let previousValue=undefined;let initialized=false;let currentItemMap=null;let currentValuesRef=null;const effect=createEffect(()=>{let value=values[node.index];if (typeof value==='function'&&value[VALUE_GETTER]){value=value();}if (initialized){if (value===previousValue){return;}if (isHtml(value)&&isHtml(previousValue)&&value._compiled===previousValue._compiled){const newValues=value._values||[];if (currentValuesRef){currentValuesRef.current=newValues;previousValue=value;return;}}if (isContain(value)&&isContain(previousValue)){const sameSource=value._renderFn.toString()===previousValue._renderFn.toString();if (sameSource){previousValue=value;return;}}const isFromEach=isHtml(value)&&value._compiled?.fromEach;const wasFromEach=isHtml(previousValue)&&previousValue._compiled?.fromEach;if (isFromEach&&wasFromEach&&currentItemMap){const result=updateKeyedList(value._compiled.children||[],previousValue._compiled.children||[],currentItemMap,placeholder,component,slotInSvg,value._compiled?.hasExplicitKeys);if (result){currentNodes=result.nodes;currentEffects=result.effects;currentItemMap=result.itemMap;previousValue=value;return;}}}previousValue=value;initialized=true;for (const oldNode of currentNodes){oldNode.remove();}for (const oldEffect of currentEffects){if (oldEffect.dispose) oldEffect.dispose();}currentNodes=[];currentEffects=[];currentItemMap=null;if (value==null||value===false){return;}if (isContain(value)&&value._renderFn){let containPreviousCompiled=null;let containValuesRef=null;let containNodes=[];let containEffects=[];const containEffect=createEffect(()=>{setRenderContext(component);const result=value._renderFn();setRenderContext(null);if (!result||!isHtml(result)||!result._compiled){for (const oldNode of containNodes){oldNode.remove();}for (const oldEffect of containEffects){if (oldEffect.dispose) oldEffect.dispose();}containNodes=[];containEffects=[];containPreviousCompiled=null;containValuesRef=null;return;}const rawValues=result._values||[];if (containPreviousCompiled===result._compiled&&containValuesRef){containValuesRef.current=rawValues;return;}for (const oldNode of containNodes){oldNode.remove();}for (const oldEffect of containEffects){if (oldEffect.dispose) oldEffect.dispose();}containValuesRef=reactive({current:rawValues});const wrappedValues=rawValues.map((_,index)=>{const getter=()=>containValuesRef.current[index];getter[VALUE_GETTER]=true;return getter;});const{fragment,effects:childEffects}=instantiateTemplate(result._compiled,wrappedValues,component,slotInSvg);const nodes=[...fragment.childNodes];insertWithoutParentTracking(placeholder,fragment);containNodes=nodes;containEffects=childEffects;containPreviousCompiled=result._compiled;currentNodes=nodes;currentEffects=childEffects;});effects.push(containEffect);return;}if (isHtml(value)){if (!value._compiled) return;if (value._compiled.fromEach&&value._compiled.children?.length>0){currentItemMap=new Map();let insertPoint=placeholder;for (const child of value._compiled.children){const key=child.key;const rawValues=child._itemValues||[];const valuesRef=reactive({current:rawValues});const wrappedValues=rawValues.map((_,index)=>{const getter=()=>valuesRef.current[index];getter[VALUE_GETTER]=true;return getter;});const{fragment,effects:childEffects}=instantiateTemplate(child,wrappedValues,component,slotInSvg);const nodes=[...fragment.childNodes];insertWithoutParentTracking(insertPoint,fragment);if (nodes.length>0){insertPoint=nodes[nodes.length-1];}currentItemMap.set(key,{nodes,effects:childEffects,compiled:child,valuesRef,slotInSvg});currentNodes.push(...nodes);currentEffects.push(...childEffects);}return;}const rawValues=value._values||[];currentValuesRef=reactive({current:rawValues});const wrappedValues=rawValues.map((_,index)=>{const getter=()=>currentValuesRef.current[index];getter[VALUE_GETTER]=true;return getter;});const{fragment,effects:childEffects}=instantiateTemplate(value._compiled,wrappedValues,component,slotInSvg);currentEffects=childEffects;const nodes=[...fragment.childNodes];insertWithoutParentTracking(placeholder,fragment);currentNodes=nodes;return;}if (isRaw(value)){const span=document.createElement('span');span.innerHTML=value.toString();insertWithoutParentTracking(placeholder,span);currentNodes=[span];return;}if (isDeferredChild(value)){const{compiled,values:childValues,parentComponent}=value;const{fragment,effects:childEffects}=instantiateTemplate(compiled,childValues,parentComponent,slotInSvg);currentEffects=childEffects;const nodes=[...fragment.childNodes];insertWithoutParentTracking(placeholder,fragment);currentNodes=nodes;return;}if (value instanceof Node){insertWithoutParentTracking(placeholder,value);currentNodes=[value];return;}if (Array.isArray(value)){let insertPoint=placeholder;for (const item of value){if (item==null||item===false) continue;if (item instanceof Node){insertWithoutParentTracking(insertPoint,item);insertPoint=item;currentNodes.push(item);continue;}if (isDeferredChild(item)){const{compiled,values:childValues,parentComponent}=item;const{fragment,effects:childEffects}=instantiateTemplate(compiled,childValues,parentComponent,slotInSvg);currentEffects.push(...childEffects);const nodes=[...fragment.childNodes];insertWithoutParentTracking(insertPoint,fragment);if (nodes.length>0){insertPoint=nodes[nodes.length-1];}currentNodes.push(...nodes);}else if (isHtml(item)){if (!item._compiled) continue;const{fragment,effects:childEffects}=instantiateTemplate(item._compiled,item._values||[],component,slotInSvg);currentEffects.push(...childEffects);const nodes=[...fragment.childNodes];insertWithoutParentTracking(insertPoint,fragment);if (nodes.length>0){insertPoint=nodes[nodes.length-1];}currentNodes.push(...nodes);}else if (item!=null){const textNode=document.createTextNode(String(item));insertPoint.after(textNode);insertPoint=textNode;currentNodes.push(textNode);}}return;}const textNode=document.createTextNode(String(value));placeholder.after(textNode);currentNodes=[textNode];});const originalDispose=effect.dispose;effect.dispose=()=>{for (const node of currentNodes){node.remove();}for (const childEffect of currentEffects){if (childEffect.dispose) childEffect.dispose();}placeholder.remove();currentNodes=[];currentEffects=[];currentItemMap=null;originalDispose();};effects.push(effect);}const RENDERER_SVG_NS='http://www.w3.org/2000/svg';function instantiateElement(node,values,component,parent,effects,inheritedSvg=false){const tag=node.tag;const inSvg=tag==='svg'||inheritedSvg||(parent&&parent.namespaceURI===RENDERER_SVG_NS);const el=inSvg?document.createElementNS(RENDERER_SVG_NS,tag):document.createElement(tag);const isCustomElement=node.isCustomElement;if (node.staticProps){for (const[name,value]of Object.entries(node.staticProps)){applyAttributeDirect(el,name,value,isCustomElement);}}for (const{name,def}of node.dynamicProps||[]){if (def.refName!==undefined){if (component&&component.refs){component.refs[def.refName]=el;effects.push({dispose(){if (component.refs[def.refName]===el){delete component.refs[def.refName];}}});}continue;}let isFirstRun=true;const effect=createEffect(()=>{const value=resolveDynamicProp(name,def,values,component,isCustomElement);if (isFirstRun){isFirstRun=false;applyAttributeDirect(el,name,value,isCustomElement);}else{applyAttribute(el,name,value,isCustomElement);}});effects.push(effect);}for (const{name,def}of node.events||[]){const handler=resolveEventHandler(name,def,values,component,isCustomElement);if (handler){if (name==='clickoutside'||name==='click-outside'){setupClickOutside(el,handler,false,effects);}else if (name==='clickoutside-stop'||name==='click-outside-stop'){setupClickOutside(el,handler,true,effects);}else{el.addEventListener(name,handler);effects.push({dispose(){el.removeEventListener(name,handler);}});}}}if (isCustomElement&&node.children&&node.children.length>0){const deferredChildren=[];const namedSlots={};for (const child of node.children){const childValues=child._itemValues!==undefined?child._itemValues:values;const slotName=getSlotName(child);const deferred=createDeferredChild(child,childValues,component);if (slotName){deferred.slotName=slotName;if (!namedSlots[slotName]){namedSlots[slotName]=[];}namedSlots[slotName].push(deferred);}else{deferredChildren.push(deferred);}}el._vdxChildren=deferredChildren;el._vdxSlots=Object.keys(namedSlots).length>0?namedSlots:{};}else{for (const child of node.children||[]){const childValues=child._itemValues!==undefined?child._itemValues:values;instantiateNode(child,childValues,component,el,effects,inSvg);}}if (isCustomElement){withoutTracking(()=>{parent.appendChild(el);});}else{parent.appendChild(el);}}function instantiateFragment(node,values,component,parent,effects,inSvg=false){for (const child of node.children||[]){const childValues=child._itemValues!==undefined?child._itemValues:values;instantiateNode(child,childValues,component,parent,effects,inSvg);}}function applyAttributeDirect(el,name,value,isCustomElement){if (name.startsWith('aria-')){if (value==null){el.removeAttribute(name);}else{el.setAttribute(name,String(value));}return;}if (value==null||value===false){el.removeAttribute(name);if (BOOLEAN_ATTRS.has(name)){el[name]=false;}if (isCustomElement&&name in el){el[name]=value;}return;}if (name==='class'||name==='className'){el.className=value;}else if (name==='style'){if (typeof value==='object'){Object.assign(el.style,value);}else{el.style.cssText=value;}}else if (name==='value'&&(el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.tagName==='SELECT')){if (el.value!==String(value)){el.value=value;}}else if (name==='checked'){el.checked=!!value;}else if (BOOLEAN_ATTRS.has(name)){const boolVal=!!value;el[name]=boolVal;if (!isCustomElement){if (boolVal){el.setAttribute(name,'');}else{el.removeAttribute(name);}}}else if (isCustomElement&&(typeof value==='object'||typeof value==='function')){el[name]=value;}else if (name.startsWith('data-')){el.setAttribute(name,value===true?'':String(value));}else if (name in el&&!name.includes('-')){try{el[name]=value;}catch{el.setAttribute(name,String(value));}}else{el.setAttribute(name,value===true?'':String(value));}}function resolveDynamicProp(name,def,values,component,isCustomElement){if (def.xModel!==undefined){if (component&&component.state){const value=getNestedValue(component.state,def.xModel);if (def.context==='x-model-checked'){return!!value;}else if (def.context==='x-model-radio'){return value===def.radioValue;}return value;}return (def.context==='x-model-checked'||def.context==='x-model-radio')?false:'';}if (def.slot!==undefined||def.slots!==undefined){let value;if (def.slots){value=def.template;for (const slotIndex of def.slots){const marker=`\x00${slotIndex}\x00`;let slotValue=values[slotIndex];if (typeof slotValue==='function'&&slotValue[VALUE_GETTER]) slotValue=slotValue();value=value.replace(marker,String(slotValue??''));}}else{value=values[def.slot];if (typeof value==='function'&&value[VALUE_GETTER]) value=value();if (def.template){const marker=`\x00${def.slot}\x00`;value=def.template.replace(marker,String(value??''));}}if (def.context==='url'){return sanitizeUrl(value)||'';}return value;}return def.value;}function resolveEventHandler(eventName,def,values,component,isCustomElement){let handler=null;if (def.xModel!==undefined){const propName=def.xModel;handler=(e)=>{if (component&&component.state){let value;if (def.customElement){value=(e.detail&&e.detail.value!==undefined)?e.detail.value:e.detail;}else{const target=e.target;if (target.type==='checkbox'){value=target.checked;}else if (target.type==='radio'){if (target.checked){value=target.value;}else{return;}}else if (target.type==='number'||target.type==='range'){value=target.valueAsNumber;if (isNaN(value)) value=target.value;}else if (target.type==='file'){value=target.files;}else{value=target.value;}}setNestedValue(component.state,propName,value);}};}else if (def.slot!==undefined){handler=values[def.slot];if (typeof handler==='function'&&handler[VALUE_GETTER]){const getter=handler;handler=(e)=>{const actualHandler=getter();if (typeof actualHandler==='function'){return actualHandler(e);}};}if (typeof handler==='string'&&component&&component[handler]){handler=component[handler].bind(component);}}else if (def.handler&&typeof def.handler==='function'){handler=def.handler;}else if (def.method&&component&&component[def.method]){handler=component[def.method].bind(component);}if (handler&&typeof handler==='function'){if (def.modifier==='prevent'){const orig=handler;handler=(e)=>{e.preventDefault();return orig(e);};}if (def.modifier==='stop'){const orig=handler;handler=(e)=>{e.stopPropagation();return orig(e);};}if (def._chainWith){const firstHandler=resolveEventHandler(eventName,def._chainWith,values,component,isCustomElement);if (firstHandler){const secondHandler=handler;handler=(e)=>{firstHandler(e);secondHandler(e);};}}if (isCustomElement&&!def.xModel){const orig=handler;handler=(e)=>{const value=(e.detail&&e.detail.value!==undefined)?e.detail.value:e.detail;return orig(e,value);};}}return handler;}function setupClickOutside(el,handler,stopPropagation,effects){const documentHandler=(e)=>{if (el.isConnected&&!el.contains(e.target)){if (stopPropagation){e.stopPropagation();}handler(e);}};const timerId=requestAnimationFrame(()=>{if (el.isConnected){document.addEventListener('click',documentHandler,true);}});effects.push({dispose(){cancelAnimationFrame(timerId);document.removeEventListener('click',documentHandler,true);}});}function getSlotName(node){if (!node.staticProps) return null;return node.staticProps.slot||null;}function getNestedValue(obj,path){if (!path||!obj) return undefined;if (hasDangerousKey(path)) return undefined;if (!path.includes('.')) return obj[path];const parts=path.split('.');let current=obj;for (const part of parts){if (current==null) return undefined;current=current[part];}return current;}function setNestedValue(obj,path,value){if (!path||!obj) return;if (hasDangerousKey(path)){console.warn(`[VDX Security] Blocked attempt to set dangerous property path: ${path}`);return;}if (!path.includes('.')){obj[path]=value;return;}const parts=path.split('.');let current=obj;for (let i=0;i<parts.length-1;i++){if (current[parts[i]]==null){current[parts[i]]={};}current=current[parts[i]];}current[parts[parts.length-1]]=value;}function hasDangerousKey(path){if (!path) return false;const parts=path.includes('.')?path.split('.'):[path];return parts.some(part=>DANGEROUS_KEYS.has(part));}registerEffectFlushHooks(beginDeferredUpdates,commitDeferredUpdates);let debugPropSetHook=null;const componentDefinitions=new Map();let isRenderingTree=false;let pendingRoots=null;function flushPendingRenders(){if (!pendingRoots) return;const roots=pendingRoots;pendingRoots=null;for (const root of roots){if (root._isMounted&&!root._isDestroyed){performTreeRender(root);}}}function flushAll(){flushEffects();flushPendingRenders();flushDOMUpdates();}function flushRenders(){flushAll();}function flushSync(fn){const result=fn();flushAll();return result;}function performTreeRender(root){if (isRenderingTree){return;}isRenderingTree=true;try{renderComponentTree(root);}finally{isRenderingTree=false;}}function renderComponentTree(component){if (!component._isMounted||component._isDestroyed){return;}try{component._doRender();}catch (error){console.error(`[${component.tagName}] Unhandled render error:`,error);}if (component._vdxChildComponents){for (const child of component._vdxChildComponents){renderComponentTree(child);}}}const processedStylesCache=new Map();function stripCSSComments(css){let result='';let i=0;const len=css.length;while (i<len){if (css[i]==='/'&&i+1<len&&css[i+1]==='*'){i+=2;while (i<len-1&&!(css[i]==='*'&&css[i+1]==='/')){i++;}i+=2;result+=' ';}else{result+=css[i];i++;}}return result;}function namespaceKeyframes(css,tagName){const keyframeNames=new Set();const keyframeRegex=/@(?:-webkit-)?keyframes\s+([a-zA-Z_][\w-]*)/g;let match;while ((match=keyframeRegex.exec(css))!==null){keyframeNames.add(match[1]);}if (keyframeNames.size===0){return css;}const prefix=tagName+'--';let result=css.replace(/@(-webkit-)?keyframes\s+([a-zA-Z_][\w-]*)/g,(match,webkit,name)=>{if (keyframeNames.has(name)){return`@${webkit || ''}keyframes ${prefix}${name}`;}return match;});for (const name of keyframeNames){const animationRegex=new RegExp(`(animation(?:-name)?\\s*:[^;]*?)\\b(${name})\\b`,'g');result=result.replace(animationRegex,`$1${prefix}${name}`);}return result;}function scopeComponentStyles(css,tagName){let result='';let i=0;css=stripCSSComments(css);css=namespaceKeyframes(css,tagName);const len=css.length;css=css.replace(/:host(\([^)]*(?:\([^)]*\)[^)]*)*\))?/g,(match,selector)=>{if (selector){return tagName+selector.slice(1,-1);}return tagName;});while (i<len){while (i<len&&/\s/.test(css[i])){result+=css[i];i++;}if (i>=len) break;if (css[i]==='@'){let j=i;while (j<len&&css[j]!=='{'){j++;}const atRuleDecl=css.substring(i,j);const isKeyframes=/^@keyframes\s/i.test(atRuleDecl)||/^@-webkit-keyframes\s/i.test(atRuleDecl);result+=css.substring(i,j+1);i=j+1;let depth=1;let atRuleBody='';while (i<len&&depth>0){if (css[i]==='{') depth++;if (css[i]==='}') depth--;if (depth>0){atRuleBody+=css[i];}i++;}if (isKeyframes){result+=atRuleBody;}else{result+=scopeComponentStyles(atRuleBody,tagName);}result+='}';continue;}let selector='';while (i<len&&css[i]!=='{'){selector+=css[i];i++;}selector=selector.trim();if (!selector){if (i<len){result+=css[i];i++;}continue;}if (i<len&&css[i]==='{'){i++;}let depth=1;let body='';while (i<len&&depth>0){if (css[i]==='{') depth++;if (css[i]==='}') depth--;if (depth>0){body+=css[i];}i++;}const scopedSelector=scopeSelector(selector,tagName);result+=`${scopedSelector} { ${body} }\n`;}return result;}function scopeSelector(selector,tagName){const selectors=selector.split(',').map(s=>s.trim());return selectors.map(sel=>{if (sel==='*'||sel==='body'||sel==='html'||sel.startsWith('@')){return sel;}if (sel.startsWith(tagName)){return sel;}return`${tagName} ${sel}`;}).join(', ');}function defineComponent(name,options){const reservedNames=new Set(['constructor','__proto__','prototype','toString','valueOf','hasOwnProperty','isPrototypeOf']);class Component extends HTMLElement{constructor(){super();this.state=reactive(options.data?options.data.call(this):{});this.props={children:[],slots:{}};this._propsVersion=reactive({v:0});if (this._pendingProps){for (const[propName,value]of Object.entries(this._pendingProps)){this.props[propName]=value;if (typeof value==='string'){this.setAttribute(propName,value);}}delete this._pendingProps;}if (options.stores){this.stores={};for (const[storeName,store]of Object.entries(options.stores)){this.stores[storeName]=store.state;}}this.refs={};if (options.methods){for (const[name,method]of Object.entries(options.methods)){this[name]=method.bind(this);}}if (options.propsChanged){this.propsChanged=options.propsChanged.bind(this);}this._isMounted=false;this._isDestroyed=false;this._suppressAttributeChange=false;this._isVdxComponent=true;this._vdxParent=null;this._vdxChildComponents=null;this._isVdxRoot=false;this._cleanups=[];}emitChange(e,value,propName='value'){if (e&&e.stopPropagation){e.stopPropagation();}this.dispatchEvent(new CustomEvent('change',{bubbles:true,composed:true,detail:{value}}));}connectedCallback(){if (this._isDestroyed){this._isDestroyed=false;}this._parseAttributes();this._isMounted=true;let parent=this.parentElement;while (parent){if (parent._isVdxComponent){this._vdxParent=parent;if (!(parent._vdxChildComponents instanceof Set)){parent._vdxChildComponents=new Set();}parent._vdxChildComponents.add(this);break;}parent=parent.parentElement;}this._isVdxRoot=!this._vdxParent;if (this.innerHTML.trim()){const lightDomContent=this.innerHTML;this.innerHTML='';const temp=document.createElement('div');temp.innerHTML=lightDomContent;const defaultChildren=[];const namedSlots={};for (const child of Array.from(temp.childNodes)){if (child.nodeType===Node.ELEMENT_NODE){const slotName=child.getAttribute('slot');if (slotName){child.removeAttribute('slot');if (!namedSlots[slotName]) namedSlots[slotName]=[];namedSlots[slotName].push(child);}else{defaultChildren.push(child);}}else if (child.nodeType===Node.TEXT_NODE&&child.textContent.trim()){defaultChildren.push(child);}}this.props.children=defaultChildren;this.props.slots=namedSlots;}if (options.template){this._injectStyles();const component=this;let currentCompiled=null;let currentCleanup=null;let afterRenderCalled=false;const instantiateErrorFallback=(templateResult)=>{if (currentCleanup){currentCleanup();component.innerHTML='';}currentCompiled=templateResult._compiled;const values=templateResult._values||[];const{fragment,cleanup:templateCleanup}=instantiateTemplate(templateResult._compiled,values,component);component.appendChild(fragment);currentCleanup=templateCleanup;};const instantiate=(templateResult)=>{if (currentCleanup){currentCleanup();component.innerHTML='';}currentCompiled=templateResult._compiled;const cache={values:templateResult._values||[]};const cacheVersion=reactive({v:0});let versionCounter=0;const computeEffect=createEffect(()=>{if (component._propsVersion){const _=component._propsVersion.v;}try{setRenderContext(component);const result=options.template.call(component);setRenderContext(null);if (result._compiled!==currentCompiled){queueMicrotask(()=>{if (!component._isDestroyed&&component._isMounted){instantiate(result);}});return;}cache.values=result._values||[];cacheVersion.v=++versionCounter;}catch (error){setRenderContext(null);if (!component._hasRenderError){component._hasRenderError=true;console.error(`[${component.tagName}] Render error:`,error);if (options.renderError){queueMicrotask(()=>{if (component._isDestroyed||!component._isMounted) return;try{const fallback=options.renderError.call(component,error);if (fallback&&fallback._compiled){instantiateErrorFallback(fallback);}}catch (fallbackError){console.error(`[${component.tagName}] renderError() also failed:`,fallbackError);}});}}}});const values=templateResult._values||[];const valueGetters=values.map((initialValue,index)=>{if (typeof initialValue==='function'){return initialValue;}const getter=()=>{const _=cacheVersion.v;return cache.values[index];};getter[VALUE_GETTER]=true;return getter;});const{fragment,cleanup:templateCleanup}=instantiateTemplate(templateResult._compiled,valueGetters,component);component.appendChild(fragment);currentCleanup=()=>{templateCleanup();computeEffect.dispose();};if (options.afterRender&&!afterRenderCalled){afterRenderCalled=true;Promise.resolve().then(()=>{if (!component._isDestroyed&&component._isMounted){options.afterRender.call(component);}}).catch(error=>{console.error(`[${component.tagName}] afterRender() error:`,error);});}};component._fgReinstantiate=()=>{if (component._isDestroyed||!component._isMounted) return;try{setRenderContext(component);const result=options.template.call(component);setRenderContext(null);if (result&&result._compiled){instantiate(result);}component._hasRenderError=false;}catch (error){setRenderContext(null);component._hasRenderError=true;if (options.renderError){try{const fallback=options.renderError.call(component,error);if (fallback&&fallback._compiled){instantiateErrorFallback(fallback);}}catch (fallbackError){console.error(`[${component.tagName}] renderError() also failed:`,fallbackError);}}console.error(`[${component.tagName}] Render error:`,error);}};try{setRenderContext(this);const templateResult=options.template.call(this);setRenderContext(null);if (templateResult&&templateResult._compiled){instantiate(templateResult);}this._hasRenderError=false;}catch (error){setRenderContext(null);this._hasRenderError=true;if (options.renderError){try{const fallback=options.renderError.call(this,error);if (fallback&&fallback._compiled){instantiateErrorFallback(fallback);}}catch (fallbackError){console.error(`[${this.tagName}] renderError() also failed:`,fallbackError);}}console.error(`[${this.tagName}] Render error:`,error);const recoveryEffect=createEffect(()=>{trackAllDependencies(component.state);if (component.stores){for (const storeState of Object.values(component.stores)){trackAllDependencies(storeState);}}if (!component._hasRenderError) return;queueMicrotask(()=>{if (component._isDestroyed||!component._isMounted) return;try{setRenderContext(component);const result=options.template.call(component);setRenderContext(null);if (result&&result._compiled){recoveryEffect.dispose();instantiate(result);component._hasRenderError=false;}}catch (retryError){setRenderContext(null);}});});this._cleanups.push(()=>recoveryEffect.dispose());}this._fineGrainedCleanup=()=>{if (currentCleanup) currentCleanup();};}if (options.mounted){queueMicrotask(()=>{if (this._isMounted&&!this._isDestroyed){options.mounted.call(this);}});}}disconnectedCallback(){this._isDestroyed=true;this._isMounted=false;if (this._vdxParent&&this._vdxParent._vdxChildComponents){this._vdxParent._vdxChildComponents.delete(this);}this._vdxParent=null;if (this._cleanups&&this._cleanups.length>0){this._cleanups.forEach(fn=>fn());this._cleanups=[];}if (this._fineGrainedCleanup){this._fineGrainedCleanup();this._fineGrainedCleanup=null;}if (options.unmounted){options.unmounted.call(this);}this.refs={};}attributeChangedCallback(name,oldValue,newValue){if (!this._isMounted||oldValue===newValue||this._suppressAttributeChange){return;}if (options.props&&name in options.props){this.props[name]=newValue;}}_getVdxRoot(){let current=this;while (current._vdxParent){current=current._vdxParent;}return current;}static get observedAttributes(){return options.props?Object.keys(options.props):[];}_parseAttributes(){if (options.props){for (const propName of Object.keys(options.props)){if (propName==='style'){continue;}if (propName in this&&this[propName]!==undefined&&this[propName]!==options.props[propName]){const value=this[propName];this.props[propName]=value;continue;}const attrValue=this.getAttribute(propName);if (attrValue!==null){this.props[propName]=attrValue;}else if (!(propName in this.props)){this.props[propName]=options.props[propName];}}}const jsonAttrsToRemove=[];for (const attr of this.attributes){if (attr.name.startsWith('json-')){const propName=attr.name.slice(5).replace(/-([a-z])/g,g=>g[1].toUpperCase());const scriptId=attr.value;const scriptEl=document.getElementById(scriptId);if (scriptEl&&scriptEl.type==='application/json'){try{const jsonData=JSON.parse(scriptEl.textContent);this.props[propName]=jsonData;}catch (e){console.warn(`[${this.tagName}] Failed to parse JSON from #${scriptId} for prop "${propName}".\n`+`  Error: ${e.message}\n`+`  Tip: Ensure the JSON in <script id="${scriptId}"> is valid. `+`Use a JSON validator if needed.`);}}else if (!scriptEl){try{const jsonData=JSON.parse(scriptId);this.props[propName]=jsonData;}catch (e){console.warn(`[${this.tagName}] Could not find element #${scriptId} or parse as inline JSON for prop "${propName}".\n`+`  Error: ${e.message}\n`+`  Tip: Either add <script type="application/json" id="${scriptId}">...</script> `+`or provide valid inline JSON.`);}}else{console.warn(`[${this.tagName}] json-${propName} references #${scriptId} which exists but is not type="application/json".\n`+`  Current type: "${scriptEl.type || '(none)'}"\n`+`  Tip: Add type="application/json" to the script tag.`);}jsonAttrsToRemove.push(attr.name);}}for (const attrName of jsonAttrsToRemove){this.removeAttribute(attrName);}}_injectStyles(){if (options.styles&&!this._stylesInjected){const styleId=`component-styles-${options.name || this.tagName}`;const tagName=this.tagName.toLowerCase();if (!document.getElementById(styleId)){let processedStyles=processedStylesCache.get(tagName);if (!processedStyles){processedStyles=scopeComponentStyles(options.styles,tagName);processedStylesCache.set(tagName,processedStyles);}const styleEl=document.createElement('style');styleEl.id=styleId;styleEl.textContent=processedStyles;document.head.appendChild(styleEl);}this._stylesInjected=true;}}render(){}$method(name){return options.methods?.[name]?.bind(this);}}const scheduleRender=(component)=>{if (component._fgReinstantiate&&component._isMounted&&!component._isDestroyed){queueMicrotask(component._fgReinstantiate);}};const createPropSetter=(propName)=>({get(){return this.props?this.props[propName]:undefined;},set(value){if (debugPropSetHook){debugPropSetHook(this.tagName||name,propName,value,value,this._isMounted);}if (!this.props){if (!this._pendingProps) this._pendingProps={};this._pendingProps[propName]=value;return;}const oldValue=this.props[propName];if (value===oldValue){return;}this.props[propName]=value;this._suppressAttributeChange=true;if (typeof value==='string'){this.setAttribute(propName,value);}else if (this.hasAttribute(propName)){this.removeAttribute(propName);}this._suppressAttributeChange=false;if (this._isMounted){if (typeof this.propsChanged==='function'){this.propsChanged(propName,value,oldValue);}if (this._propsVersion){this._propsVersion.v++;if (this._hasRenderError){scheduleRender(this);}}}},enumerable:true,configurable:true});Object.defineProperty(Component.prototype,'children',{get(){return this.props?this.props.children:undefined;},set(value){if (debugPropSetHook){debugPropSetHook(this.tagName||name,'children',value,value,this._isMounted);}if (!this.props){if (!this._pendingProps) this._pendingProps={};this._pendingProps.children=value;return;}this.props.children=value;if (this._isMounted&&this._propsVersion){this._propsVersion.v++;}},enumerable:true,configurable:true});Object.defineProperty(Component.prototype,'slots',{get(){return this.props?this.props.slots:undefined;},set(value){if (debugPropSetHook){debugPropSetHook(this.tagName||name,'slots',value,value,this._isMounted);}if (!this.props){if (!this._pendingProps) this._pendingProps={};this._pendingProps.slots=value;return;}this.props.slots=value;if (this._isMounted&&this._propsVersion){this._propsVersion.v++;}},enumerable:true,configurable:true});Object.defineProperty(Component.prototype,'_vdxChildren',{get(){return this.props?this.props.children:undefined;},set(value){if (debugPropSetHook){debugPropSetHook(this.tagName||name,'_vdxChildren',value,value,this._isMounted);}if (!this.props){if (!this._pendingProps) this._pendingProps={};this._pendingProps.children=value;return;}this.props.children=value;if (this._isMounted&&this._propsVersion){this._propsVersion.v++;}},enumerable:true,configurable:true});Object.defineProperty(Component.prototype,'_vdxSlots',{get(){return this.props?this.props.slots:undefined;},set(value){if (debugPropSetHook){debugPropSetHook(this.tagName||name,'_vdxSlots',value,value,this._isMounted);}if (!this.props){if (!this._pendingProps) this._pendingProps={};this._pendingProps.slots=value;return;}this.props.slots=value;if (this._isMounted&&this._propsVersion){this._propsVersion.v++;}},enumerable:true,configurable:true});if (options.props){for (const propName of Object.keys(options.props)){if (reservedNames.has(propName)||propName==='children'||propName==='slots'){if (reservedNames.has(propName)){console.warn(`[Security] Skipping reserved prop name: ${propName}`);}continue;}if (propName==='style'){Object.defineProperty(Component.prototype,'_vdxStyle',{get(){return this.props?this.props.style:undefined;},set(value){if (debugPropSetHook){debugPropSetHook(this.tagName||name,'_vdxStyle',value,value,this._isMounted);}if (!this.props){if (!this._pendingProps) this._pendingProps={};this._pendingProps.style=value;return;}this.props.style=value;if (this._isMounted) scheduleRender(this);},enumerable:true,configurable:true});continue;}Object.defineProperty(Component.prototype,propName,createPropSetter(propName));}}if (!customElements.get(name)){customElements.define(name,Component);componentDefinitions.set(name,Component);}return Component;}defineComponent('x-await-then',{props:{promise:null,then:null,pending:null,catch:null},data(){return{status:'pending',value:null,err:null};},methods:{_trackPromise(){const promise=this.props.promise;if (promise===this._trackedPromise){return;}this._trackedPromise=promise;if (promise==null||typeof promise.then!=='function'){this.state.status='resolved';this.state.value=promise;this.state.err=null;return;}this.state.status='pending';this.state.value=null;this.state.err=null;const tracked=promise;promise.then(resolvedValue=>{if (this._trackedPromise===tracked){this.state.value=resolvedValue;this.state.status='resolved';}},error=>{if (this._trackedPromise===tracked){this.state.err=error;this.state.status='rejected';}});},_getContent(){const{status,value,err}=this.state;const thenFn=this.props.then;const pendingContent=this.props.pending;const catchFn=this.props.catch;if (status==='pending'){return pendingContent||html``;}if (status==='rejected'){if (typeof catchFn==='function'){return catchFn(err);}return catchFn||html``;}if (typeof thenFn==='function'){try{return thenFn(value);}catch (err){if (typeof catchFn==='function'){return catchFn(err);}if (catchFn){return catchFn;}throw err;}}return html``;}},template(){this._trackPromise();return this._getContent();}});const STORE_DANGEROUS_KEYS=new Set(['__proto__','prototype','constructor','__defineGetter__','__defineSetter__','__lookupGetter__','__lookupSetter__']);function filterDangerousKeys(obj){if (!obj||typeof obj!=='object') return obj;const filtered={};for (const key of Object.keys(obj)){if (!STORE_DANGEROUS_KEYS.has(key)){filtered[key]=obj[key];}else{console.warn(`[VDX Security] Blocked attempt to set dangerous store key: ${key}`);}}return filtered;}function createStore(initial){const state=reactive(initial);return{get state(){return state;},subscribe(fn){const effect=createEffect(()=>{try{fn(state);}catch (error){console.error('Error in store subscriber:',error);}});return ()=>{effect.dispose();};},set(newState){Object.assign(state,filterDangerousKeys(newState));},update(updater){const newState=updater(state);if (newState){Object.assign(state,filterDangerousKeys(newState));}}};}export{defineComponent,flushRenders,flushSync,reactive,createEffect,trackAllDependencies,isReactive,watch,computed,memo,untracked,isUntracked,withoutTracking,flushEffects,html,raw,when,each,memoEach,createMemoCache,awaitThen,contain,pruneTemplateCache,createStore,};
//# sourceMappingURL=framework.js.map
