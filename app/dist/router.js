import{createStore,pruneTemplateCache,html,defineComponent}from'./framework.js';let _router=null;function shallowEqual(a,b){if (a===b) return true;if (!a||!b) return false;const keysA=Object.keys(a);const keysB=Object.keys(b);if (keysA.length!==keysB.length) return false;for (const key of keysA){if (a[key]!==b[key]) return false;}return true;}export function getRouter(){return _router;}function parseQuery(queryString){if (!queryString) return{};const params={};const pairs=queryString.split('&');for (const pair of pairs){const[key,value]=pair.split('=');if (key){params[decodeURIComponent(key)]=decodeURIComponent(value||'');}}return params;}function stringifyQuery(params){const pairs=[];for (const[key,value]of Object.entries(params)){if (value!=null){pairs.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);}}return pairs.join('&');}function isValidCustomElementName(name){if (!name||typeof name!=='string'){return false;}if (!name.includes('-')){return false;}if (!/^[a-z]/.test(name)){return false;}if (!/^[a-z][a-z0-9-]*$/.test(name)){return false;}const reserved=['annotation-xml','color-profile','font-face','font-face-src','font-face-uri','font-face-format','font-face-name','missing-glyph'];if (reserved.includes(name)){return false;}return true;}function compileRoutePattern(pattern){const paramNames=[];let regexStr=pattern.replace(/[.+?^${}()|[\]\\]/g,'\\$&').replace(/:([a-zA-Z_][a-zA-Z0-9_]*)/g,(_,paramName)=>{paramNames.push(paramName);return'([^/]+)';});if (regexStr.endsWith('/')){regexStr=regexStr.slice(0,-1)+'/?';}else{regexStr=regexStr+'/?';}return{regex:new RegExp(`^${regexStr}$`),paramNames};}function matchRoute(path,compiledPattern){const match=path.match(compiledPattern.regex);if (!match){return{match:false,params:{}};}const params={};for (let i=0;i<compiledPattern.paramNames.length;i++){params[compiledPattern.paramNames[i]]=decodeURIComponent(match[i+1]);}return{match:true,params};}export class Router{constructor(routes,options={}){this.routes={};this.beforeHooks=[];this.afterHooks=[];this.outletElement=null;this.loadedComponents=new Set();this.useHTML5=this._detectRoutingMode();this.base=this._getBase();this._flattenRoutes(routes);this.currentRoute=createStore({path:'/',query:{},params:{},component:null,meta:{}});this._listeners=[];if (this.useHTML5){const popstateHandler=()=>this.handleRoute();window.addEventListener('popstate',popstateHandler);this._listeners.push({event:'popstate',handler:popstateHandler});const hashchangeHandler=()=>{if (window.location.hash){const path=window.location.hash.slice(1);this.replace(path);}};window.addEventListener('hashchange',hashchangeHandler);this._listeners.push({event:'hashchange',handler:hashchangeHandler});}else{const hashchangeHandler=()=>this.handleRoute();window.addEventListener('hashchange',hashchangeHandler);this._listeners.push({event:'hashchange',handler:hashchangeHandler});}this.handleRoute();}destroy(){this._listeners.forEach(({event,handler})=>{window.removeEventListener(event,handler);});this._listeners=[];this.beforeHooks=[];this.afterHooks=[];}_detectRoutingMode(){const baseTag=document.querySelector('base[href]');return!!baseTag;}_getBase(){if (this.useHTML5){const baseTag=document.querySelector('base[href]');if (baseTag){let base=baseTag.getAttribute('href');if (base==='/'){return'';}if (base.endsWith('/')){base=base.slice(0,-1);}return base;}return'';}return window.location.origin+window.location.pathname+'#';}_flattenRoutes(routes,prefix=''){for (const[path,config]of Object.entries(routes)){const fullPath=prefix+(path==='/'?'':path);const compiled=compileRoutePattern(fullPath||'/');if (config.routes){this._flattenRoutes(config.routes,fullPath);if (config.component){this.routes[fullPath]={...config,_compiled:compiled};}}else{this.routes[fullPath]={...config,_compiled:compiled};}}if (!this.routes['']){this.routes['']=this.routes['/']||{component:null,_compiled:compileRoutePattern('/')};}}navigate(path,query={}){const queryString=stringifyQuery(query);const fullPath=queryString?`${path}?${queryString}`:path;if (this.useHTML5){const url=this.base+fullPath;window.history.pushState({path:fullPath},'',url);this.handleRoute();}else{window.location.hash=fullPath;}}replace(path,query={}){const queryString=stringifyQuery(query);const fullPath=queryString?`${path}?${queryString}`:path;if (this.useHTML5){const url=this.base+fullPath;window.history.replaceState({path:fullPath},'',url);this.handleRoute();}else{window.location.replace(`#${fullPath}`);}}back(){window.history.back();}forward(){window.history.forward();}beforeEach(fn){this.beforeHooks.push(fn);}afterEach(fn){this.afterHooks.push(fn);}_findRoute(path){if (!path) path='/';if (!path.startsWith('/')) path='/'+path;let route=this.routes[path];if (route){return{route,params:{}};}if (path.endsWith('/')&&path.length>1){route=this.routes[path.slice(0,-1)];if (route){return{route,params:{}};}}if (!path.endsWith('/')){route=this.routes[path+'/'];if (route){return{route,params:{}};}}for (const[pattern,routeConfig]of Object.entries(this.routes)){if (!routeConfig._compiled) continue;const result=matchRoute(path,routeConfig._compiled);if (result.match){return{route:routeConfig,params:result.params};}}return{route:this.routes['/404']||this.routes['']||{component:null},params:{}};}async handleRoute(){let path,queryString;if (this.useHTML5){const fullPath=window.location.pathname;let relativePath=fullPath;if (this.base&&this.base.length>0&&fullPath.startsWith(this.base)){relativePath=fullPath.slice(this.base.length);}if (!relativePath.startsWith('/')){relativePath='/'+relativePath;}queryString=window.location.search.slice(1);[path]=relativePath.split('?');}else{const hash=window.location.hash.slice(1)||'';[path,queryString]=hash.split('?');}if (!path) path='/';if (!path.startsWith('/')) path='/'+path;const query=parseQuery(queryString);const{route,params}=this._findRoute(path);for (const hook of this.beforeHooks){const result=await hook({path,query,params,route});if (result===false){return;}}if (route.load&&route.component&&!this.loadedComponents.has(route.component)){try{await route.load();this.loadedComponents.add(route.component);}catch (error){console.error(`Failed to load component for route ${path}:`,error);const fallback=this.routes['/404']||{component:'page-not-found'};this.currentRoute.set({path,query,params:{},component:fallback.component,meta:fallback.meta||{}});this._renderOutlet();return;}}this.currentRoute.set({path,query,params,component:route.component,meta:route.meta||{}});this._renderOutlet();for (const hook of this.afterHooks){await hook({path,query,params,route});}pruneTemplateCache();}setOutlet(element){if (this._outletUnsubscribe){this._outletUnsubscribe();}this.outletElement=element;this._outletUnsubscribe=this.currentRoute.subscribe(()=>{this._renderOutlet();});}_renderOutlet(){if (!this.outletElement){return;}const{component,params,query}=this.currentRoute.state;if (!component){this.outletElement.textContent='';const notFoundElement=document.createElement('page-not-found');this.outletElement.appendChild(notFoundElement);this._currentComponent=null;this._currentElement=null;return;}if (!isValidCustomElementName(component)){console.error(`[Router] Invalid component name: "${component}". Component names must be lowercase, contain a hyphen, and start with a letter.`);this.outletElement.textContent='';const errorElement=document.createElement('page-not-found');this.outletElement.appendChild(errorElement);this._currentComponent=null;this._currentElement=null;return;}const existingElement=this.outletElement.firstElementChild;if (existingElement&&existingElement.tagName.toLowerCase()===component){if (!shallowEqual(existingElement.params,params)){existingElement.params=params;}if (!shallowEqual(existingElement.query,query)){existingElement.query=query;}this._currentElement=existingElement;}else{const element=document.createElement(component);element.params=params;element.query=query;this.outletElement.innerHTML='';this.outletElement.appendChild(element);this._currentComponent=component;this._currentElement=element;}}url(path,query={}){const queryString=stringifyQuery(query);const fullPath=queryString?`${path}?${queryString}`:path;if (this.useHTML5){return this.base+fullPath;}else{return`#${fullPath}`;}}}function init(){defineComponent('router-link',{props:{to:'/'},methods:{handleClick(e){if (_router&&_router.useHTML5){e.preventDefault();_router.navigate(this.props.to);}}},template(){const href=_router?_router.url(this.props.to):`#${this.props.to}`;return html`
                <a href="${href}" on-click="handleClick">${this.props.children}</a>
            `;}});if (customElements.get('router-outlet')){return;}class RouterOutlet extends HTMLElement{connectedCallback(){}}customElements.define('router-outlet',RouterOutlet);}init();export function enableRouting(outlet,routes,options={}){if (!_router){_router=new Router(routes,options);}_router.setOutlet(outlet);return _router;}
//# sourceMappingURL=router.js.map
